############################################################
# HHV-6B U90 Bayesian MCC Tree Visualization
# ----------------------------------------------------------
#   This script reads in a Maximum Clade Credibility (MCC) tree
#   generated by BEAST, extracts posterior probabilities, and
#   visualizes the tree with branches colored by posterior support
#   and node labels showing posterior values.
#
# Inputs:
#   - MCC tree file in NEXUS format (e.g., "U90.MCC.tree")
#
# Outputs:
#   - A ggtree plot object showing the MCC tree with posterior
#     probabilities annotated and branches colored by support.
############################################################

# Load required packages
library(ape)
library(treeio)
library(ggtree)
library(ggplot2)
library(cowplot)
library(ggrepel)

# Step 1: Define tree file
mcc_tree <- "U90.MCC.tree"   # BEAST MCC tree file (NEXUS format)


# Step 2: Read Bayesian MCC tree
# read.beast() parses BEAST output (including posterior probabilities)
beast_tree <- read.beast(mcc_tree)


# Step 3: Extract internal nodes for labeling
# ggtree() returns a data frame with node information
d_bayes <- ggtree(beast_tree)$data
internal_nodes_bayes <- d_bayes[!d_bayes$isTip, ]  # keep only internal nodes

# Step 4: Build the visualization
p_bayes <- ggtree(beast_tree) +
  # Color branches by posterior probability (0–1)
  geom_tree(aes(color = posterior), size = 1.0) +
  
  # Add tip labels (sequence names)
  geom_tiplab(size = 1.5) +
  
  # Add posterior labels at internal nodes
  geom_label_repel(
    data = internal_nodes_bayes,
    aes(x = x, y = y, label = round(posterior, 2)),
    fill = "white", color = "black", size = 2.5,
    box.padding = 0.3, max.overlaps = Inf
  ) +
  
  # Color scale for posterior probabilities (0–1)
  scale_color_viridis_c(name = "Posterior",
                        limits = c(0, 1), direction = -1) +
  
  # Add a title
  ggtitle("U90 Bayesian MCC Tree: Branches colored by posterior support") +
  
  # Center title
  theme(plot.title = element_text(hjust = 0.5))


# Step 5: Display tree
p_bayes
