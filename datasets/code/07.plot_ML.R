############################################################
# HHV-6B U90 Maximum Likelihood Tree Visualization
# ----------------------------------------------------------
#   This script reads in a Maximum Likelihood (ML) tree
#   generated by IQ-TREE, reroots it on a specified outgroup,
#   and visualizes the tree with bootstrap support values
#   displayed and branches colored by bootstrap strength.
#
# Inputs:
#   - ML tree file in Newick format (e.g., "U90.ML.treefile")
#   - Outgroup taxon name (must match a tip label in the tree)
#
# Outputs:
#   - A ggtree plot object showing the ML tree with bootstrap
#     values annotated and branches colored by support.
############################################################

# Load required packages
library(ape)
library(treeio)
library(ggtree)
library(ggplot2)
library(cowplot)
library(ggrepel)

# Step 1: Read in the ML tree
ml_tree <- "U90.ML.treefile"   # IQ-TREE ML tree output file
iqtree <- read.tree(ml_tree)   # read Newick tree into R

# Step 2: Reroot the tree on a chosen outgroup
# Outgroup should be a tip label present in the tree
outgroup <- "HHV6A_outgroup_KP257584.1" # change as needed
iqtree.root <- root(iqtree, outgroup = outgroup)

# Step 3: Extract internal nodes for labeling
# ggtree() returns a data frame with node information
d_ml <- ggtree(iqtree.root)$data
internal_nodes_ml <- d_ml[!d_ml$isTip, ]  # keep only internal nodes

# Step 4: Build the visualization
p_ml <- ggtree(iqtree.root) +
  # Color branches by bootstrap values (stored in node labels)
  geom_tree(aes(color = as.numeric(label)), size = 1.2) +
  
  # Add tip labels (sequence names)
  geom_tiplab(size = 2) +
  
  # Add bootstrap labels at internal nodes
  geom_label_repel(
    data = internal_nodes_ml,
    aes(x = x, y = y, label = label),
    fill = "white", color = "black", size = 2.5,
    box.padding = 0.3, max.overlaps = Inf
  ) +
  
  # Color scale for bootstrap values (0â€“100)
  scale_color_viridis_c(name = "Bootstrap Value",
                        limits = c(0, 100), direction = -1) +
  
  # Add a title
  ggtitle("U90 ML Tree: Branches colored by bootstrap support") +
  
  # Center the title
  theme(plot.title = element_text(hjust = 0.5))


# Step 5: Display the tree
p_ml
